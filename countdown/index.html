<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="manifest.json"/>
    <title>倒计时</title>
    <style>
        *{
            padding: 0;
            margin: 0;
            box-sizing: border-box;
        }
        h1{font-size: 30px;}
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            gap: 20px;
        }

        #countdownarea{
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 40px;
        }
        @media screen and (min-width: 480px) {
            #countdownarea{
                flex-direction: row;
                flex-wrap: wrap;
                gap: 30px;
            }
        }

        .remind{
            position: fixed;
            top: 50%;
            z-index: 1000;
            width: 300px;
            min-height: 100px;
            background-color: #ffff00;
            border-radius: 30px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            justify-content: center;
            align-items: center;
            font-size: 25px;
            font-weight: 600;
        }
        .remind p::after{
            content: "❌";
        }
        .countdown {
            background-color: #eeeeee72;
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            max-width: 400px;
            width: 100%;
            gap: 12px;
        }
        .timeInput, .input-message, .btn, .countdown-display {
            font-size: 30px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        .timeInput {
            flex-direction: column;
            height: auto;
            gap: 12px;
            font-size: 20px;
        }
        .timeInput div, .afterBegain {
            display: flex;
            flex-wrap: nowrap;
            text-wrap: nowrap;
            justify-content: center;
            align-items: center;
            width: 100%;
            gap: 3px;
        }
        .hour, .min, .sec {
            min-width: 45px;
            height: 30px;
            font-size: 20px;
            text-align: center;
        }
        .range {
            width: 100%;
            height: 20px;
            margin: 0 auto;
        }
         .countdown-display {
            height: 60px;
            background-color: #f0f0f0;
            color: #852626;
        }
        .input-message {
            width: 100%;
            margin: 0 auto;
            padding: 0 10px;
            border: #f0f0f0 solid 1px;
        }
        .btn {
            width: 100%;
            background-color: #428543;
            color: white;
            border: none;
            cursor: pointer;
        }
        .hidden {
            display: none;
        }
        .stopbtn {
            background-color: #ff8980;
        }
    </style>
</head>
<body>
    <div id="message" class="message"></div>
    <div id="remind" class="remind hidden"></div>
    <div id="countdownarea">
        <div id="countdown_1" class="countdown">
            <h1>倒计时⏳</h1>
            <div class="timeInput">
                <div>
                    <input type="number" class="hour" value="0" min="0" max="99" autocomplete="off">小时
                    <input type="number" class="min" value="0" min="0" max="59" autocomplete="off">分钟
                    <input type="number" class="sec" value="0" min="0" max="59" autocomplete="off">秒
                </div>
                <input type="range" class="range" min="0" max="3600" value="0" oninput="updateRange(event)">
            </div>
            <div class="afterBegain">
                <input type="text" placeholder="请输入事件" class="input-message">
                <div class="countdown-display hidden"></div>
            </div>
            <button onclick="begainCount(event)" class="btn">开始</button>
        </div>
    </div>

    <script>
        const start = {};
        const countdown = {};
        function begainCount (e) {
            const thisCountdown = e.target.closest('.countdown');
            const countid = thisCountdown.id;
            start[countid] = !start[countid];
            const countnum = document.querySelectorAll('.countdown').length;
            if (start[countid] && countid.split('_')[1] == countnum){addcountdown()}
            const timeInput = thisCountdown.querySelector('.timeInput');
            const messageInput = thisCountdown.querySelector('.input-message');
            thisCountdown.querySelector('h1').classList.toggle('hidden');
            thisCountdown.querySelector('.timeInput').classList.toggle('hidden');
            thisCountdown.querySelector('.btn').classList.toggle('stopbtn');
            thisCountdown.querySelector('.countdown-display').classList.toggle('hidden');
            if (start[countid]){
                e.target.innerHTML = '停止';
                const inputHours = thisCountdown.querySelector('.hour').value;
                const inputMin = thisCountdown.querySelector('.min').value;
                const inputSec = thisCountdown.querySelector('.sec').value;
                const totalSeconds = inputHours * 3600 + inputMin * 60 + inputSec * 1;
                const begainTime = new Date();
                thisCountdown.querySelector('.countdown-display').innerHTML = '正在倒计时...';
                countdown[countid] = setInterval( () => {
                    const now = new Date();
                    const diff = now - begainTime;
                    const seconds = Math.floor(totalSeconds - diff / 1000);
                    const minutes = Math.floor(seconds / 60);
                    const hours = Math.floor(minutes / 60);

                    thisCountdown.querySelector('.countdown-display').innerHTML = `${hours}h ${minutes % 60}m ${seconds % 60}s`;
                    if (seconds <= 0) {
                        clearInterval(countdown[countid]);
                        delete countdown[countid];
                        thisCountdown.querySelector('.countdown-display').innerHTML = messageInput.value || '时间到！';
                        start[countid] = false;
                        e.target.innerHTML = '开始';
                        showRemind(messageInput, countid);
                        thisCountdown.querySelector('h1').classList.toggle('hidden');
                        thisCountdown.querySelector('.timeInput').classList.toggle('hidden');
                        thisCountdown.querySelector('.btn').classList.toggle('stopbtn');
                        thisCountdown.querySelector('.countdown-display').classList.toggle('hidden');
                    }
                }, 1000);
            }else {
                e.target.innerHTML = '开始';
                console.log('清除倒计时');
                thisCountdown.querySelector('.countdown-display').innerHTML = '';
                clearInterval(countdown[countid]);
                delete countdown[countid];
                start[countid] = false;
            }
        };

        let audio;
        async function showRemind (messageInput, countid){
            const remind = document.getElementById('remind');
            const ps = remind.querySelectorAll('p');
            if(ps.length < 1){
                audio = new Audio('sound.mp3');
                await audio.play();
            }
            const p = document.createElement('p');
            p.innerHTML = messageInput.value || '时间到！';
            p.classList.add(countid);
            remind.appendChild(p);
            p.addEventListener('click', ()=>{
                p.remove();
                const psnow = remind.querySelectorAll('p');
                if(psnow.length < 1){
                    remind.classList.add('hidden');
                    audio.pause();
                }
            })
            remind.classList.remove('hidden');
        }

        function updateRange(e) {
            const rangeValue = e.target.value;
            const timeInput = e.target.parentElement;
            timeInput.querySelector('.hour').value = Math.floor(rangeValue / 3600);
            timeInput.querySelector('.min').value = Math.floor((rangeValue % 3600) / 60);
            timeInput.querySelector('.sec').value = rangeValue % 60;
        }

        function addcountdown(){
            const newCountdown = document.createElement('div');
            const count = document.querySelectorAll('.countdown').length + 1;
            newCountdown.id = `countdown_${count}`;
            newCountdown.classList.add('countdown');
            newCountdown.innerHTML = `
                <h1>倒计时⏳${count}</h1>
                <div class="timeInput">
                    <div>
                        <input type="number" class="hour" value="0" min="0" max="99" autocomplete="off">小时
                        <input type="number" class="min" value="0" min="0" max="59" autocomplete="off">分钟
                        <input type="number" class="sec" value="0" min="0" max="59" autocomplete="off">秒
                    </div>
                    <input type="range" class="range" min="0" max="3600" value="0" oninput="updateRange(event)">
                </div>
                <div class="afterBegain">
                    <input type="text" placeholder="请输入事件" class="input-message">
                    <div class="countdown-display hidden"></div>
                </div>
                <button onclick="begainCount(event)" class="btn">开始</button>
            `;
            document.querySelector('#countdownarea').appendChild(newCountdown);
        }

        window.addEventListener('load', async () => {
            if('serviceWorker' in navigator) {
                try{
                    const registration = await navigator.serviceWorker.register('sw.js')
                }catch(err){
                    console.log(err)
                }
            }else{
                console.log('浏览器不支持service worker注册失败')
            }
            if(!navigator.onLine){
                message('本页面采用PWA技术，没有网络也能使用') 
                new Notification('提示', {body: '本页面采用PWA技术，没有网络也能使用'});
            }
            window.addEventListener('online', ()=>{
                message('网络已连接') 
                new Notification('提示', {body: '网络已连接'});
            })
        });

        let timer;
        function message(info){
            const message = document.getElementById('message');
            message.innerHTML = info;
            clearTimeout(timer);
            timer = setTimeout(()=>{message.innerHTML = ''},3000);
        }

    </script>
</body>
</html>